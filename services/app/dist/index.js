(()=>{"use strict";var e={280:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0});var n={server:{port:null!==(r=process.env.PORT)&&void 0!==r?r:3001,cors:{origin:"http://localhost:3000"}}};t.default=n},955:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.authRepository=void 0;var i=r(896),u=n(r(784));i.container.register("authRepository",{useClass:u.default}),t.authRepository=i.container.resolve("authRepository")},536:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var i=n(r(807)),u=r(818);t.default=function(){return{login:function(e,t){if(!e.user)throw new i.default("認証に失敗しました",401);var r=(0,u.signToken)(e.user);t.status(200).send({id:e.user.id,token:r})}}}},533:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r){this._id=e,this._identifier=t,this._credential=r}return Object.defineProperty(e.prototype,"id",{get:function(){if(!this._id.isGenerated)throw new Error("IDが生成されていません");return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"credential",{get:function(){return this._credential},enumerable:!1,configurable:!0}),e.prototype.setId=function(t){return new e(t,this._identifier,this._credential)},e}();t.default=r},402:function(e,t,r){var n,i,u=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,u){function o(e){try{s(n.next(e))}catch(e){u(e)}}function a(e){try{s(n.throw(e))}catch(e){u(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,i,u,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&u[0]?n.return:u[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,u[1])).done)return i;switch(n=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,n=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){o=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){o.label=u[1];break}if(6===u[0]&&o.label<i[1]){o.label=i[1],i=u;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(u);break}i[2]&&o.ops.pop(),o.trys.pop();continue}u=t.call(e,o)}catch(e){u=[6,e],n=0}finally{r=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var s=a(r(511)),l=a(r(807)),c=r(518),f=r(136),d=r(253),p=r(818),h=r(482),_=r(955);s.default.use(new c.Strategy({usernameField:"email",passwordField:"password",session:!1},(function(e,t,r){return u(void 0,void 0,void 0,(function(){var n,i;return o(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,3]),[4,_.authRepository.loginByEmail(e)];case 1:return(n=u.sent())&&(0,h.compareSync)(t,n.credential)?[2,r(null,{id:n.id.value})]:[2,r(new l.default("メールアドレスまたはパスワードが誤っています",401))];case 2:return i=u.sent(),[2,r(i)];case 3:return[2]}}))}))})));var v={jwtFromRequest:f.ExtractJwt.fromAuthHeaderAsBearerToken(),secretOrKey:p.JWT_SECRET_KEY};s.default.use(new f.Strategy(v,(function(e,t){t(null,e)}))),s.default.use(new d.Strategy({clientID:null!==(n=process.env.GITHUB_CLIENT_ID)&&void 0!==n?n:"INVALID_CLIENT_ID",clientSecret:null!==(i=process.env.GITHUB_CLIENT_SECRET)&&void 0!==i?i:"INVALID_CLIENT_SECRET",callbackURL:"http://localhost:3001/api/v1/auth/github/callback"},(function(e,t,r,n){return u(void 0,void 0,void 0,(function(){var t,i;return o(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,3]),[4,_.authRepository.authByGithub(r.username,r.id,e)];case 1:return t=u.sent(),[2,n(null,{id:t.id.value})];case 2:return i=u.sent(),[2,n(i)];case 3:return[2]}}))}))}))),t.default=s.default},784:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,u){function o(e){try{s(n.next(e))}catch(e){u(e)}}function a(e){try{s(n.throw(e))}catch(e){u(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}s((n=n.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var r,n,i,u,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&u[0]?n.return:u[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,u[1])).done)return i;switch(n=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,n=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){o=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){o.label=u[1];break}if(6===u[0]&&o.label<i[1]){o.label=i[1],i=u;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(u);break}i[2]&&o.ops.pop(),o.trys.pop();continue}u=t.call(e,o)}catch(e){u=[6,e],n=0}finally{r=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=u(r(533)),a=r(701),s=r(203),l=function(){function e(){}return e.prototype.loginByEmail=function(e){return n(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return[4,s.prisma.users_auths.findFirst({where:{identity_type:"email",identifier:e},include:{users:{select:{id:!0}}}})];case 1:return(t=r.sent())?[2,this.createAuthCredential(t.users.id,t.identifier,t.credential)]:[2,t]}}))}))},e.prototype.authByGithub=function(e,t,r){return n(this,void 0,void 0,(function(){var n,u,o;return i(this,(function(i){switch(i.label){case 0:return[4,s.prisma.users_auths.findFirst({where:{identity_type:"github",identifier:t},include:{users:{select:{id:!0}}}})];case 1:return(n=i.sent())?[4,s.prisma.users_auths.update({where:{id:n.id},data:{credential:r}})]:[3,3];case 2:return i.sent(),[2,this.createAuthCredential(n.users.id,n.identifier,r)];case 3:return[4,s.prisma.users.create({data:{nickname:e}})];case 4:return u=i.sent(),console.log(u),[4,s.prisma.users_auths.create({data:{identity_type:"github",identifier:t,credential:r,users:{connect:{id:u.id}}}})];case 5:return o=i.sent(),[2,this.createAuthCredential(u.id,o.identifier,o.credential)]}}))}))},e.prototype.createAuthCredential=function(e,t,r){var n=new a.GeneratedId(e);return new o.default(n,t,r)},e}();t.default=l},701:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NoneId=t.GeneratedId=void 0;var i=n(r(807)),u=function(){function e(e){this.isGenerated=!0,this._value=e,Object.freeze(this)}return e.validate=function(t){if(t<1||!Number.isInteger(t))throw new i.default("IDは1以上の整数で入力してください",400);return new e(t)},Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!1,configurable:!0}),e}();t.GeneratedId=u;var o=function(){function e(){this.isGenerated=!1}return Object.defineProperty(e.prototype,"value",{get:function(){throw new i.default("IDが生成されていません",400)},enumerable:!1,configurable:!0}),e.instance=new e,e}();t.NoneId=o},203:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.prisma=void 0;var n=r(524);t.prisma=new n.PrismaClient},39:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(236);var i=n(r(280)),u=r(55),o=i.default.server.port;u.listen(o,(function(){console.log("Server listening on port ".concat(o))}))},635:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var i=n(r(527)),u=n(r(565));t.default=function(e){e.use((function(e,t,r,n){var o=e.status||500,a=new i.default;u.default.error(e.message),r.status(o).send(a.error(e))}))}},919:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.authRouter=void 0;var i=n(r(402)),u=n(r(536));t.authRouter=function(e){var t=e.Router(),r=(0,u.default)();return t.post("/auth/login",i.default.authenticate("local",{session:!1,scope:["user:email"]}),r.login),t.get("/auth/github",i.default.authenticate("github",{session:!1})),t.get("/auth/github/callback",i.default.authenticate("github",{session:!1}),r.login),t}},736:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(919),t)},55:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var i=n(r(582)),u=n(r(685)),o=n(r(860)),a=n(r(280)),s=n(r(635)),l=n(r(402)),c=r(736),f=(0,o.default)(),d=u.default.createServer(f);f.use(o.default.json()),f.use(o.default.urlencoded({extended:!1}));var p={origin:a.default.server.cors.origin,optionsSuccessStatus:200};f.use((0,i.default)(p)),f.use(l.default.initialize()),f.use("/api/v1",(0,c.authRouter)(o.default)),(0,s.default)(f),e.exports=d},807:function(e,t){var r,n=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(t,r){void 0===r&&(r=500);var n=e.call(this,t)||this;return n.message=t,n.status=r,n}return n(t,e),t}(Error);t.default=i},482:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.compareSync=t.hashSync=void 0;var i=n(r(96));t.hashSync=function(e){return i.default.hashSync(e,10)},t.compareSync=function(e,t){return i.default.compareSync(e,t)}},818:function(e,t,r){var n,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.signToken=t.JWT_SECRET_KEY=void 0;var u=i(r(344));t.JWT_SECRET_KEY=null!==(n=process.env.JWT_SECRET_KEY)&&void 0!==n?n:"MY_SECRET_KEY",t.signToken=function(e,r){return u.default.sign(e,t.JWT_SECRET_KEY,r)}},565:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var n=r(42);t.default=n.logger},42:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;var i=n(r(773));t.logger=i.default.createLogger({level:"info",format:i.default.format.json(),defaultMeta:{service:"user-service"},transports:[new i.default.transports.File({filename:"logs/error.log",level:"error"}),new i.default.transports.File({filename:"logs/combined.log"})]})},527:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.error=function(e){return{message:e.message}},e}();t.default=r},524:e=>{e.exports=require("@prisma/client")},96:e=>{e.exports=require("bcrypt")},582:e=>{e.exports=require("cors")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},511:e=>{e.exports=require("passport")},253:e=>{e.exports=require("passport-github2")},136:e=>{e.exports=require("passport-jwt")},518:e=>{e.exports=require("passport-local")},236:e=>{e.exports=require("reflect-metadata")},896:e=>{e.exports=require("tsyringe")},773:e=>{e.exports=require("winston")},685:e=>{e.exports=require("http")}},t={};!function r(n){var i=t[n];if(void 0!==i)return i.exports;var u=t[n]={exports:{}};return e[n].call(u.exports,u,u.exports,r),u.exports}(39)})();