(()=>{"use strict";var e={7280:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0});var n={server:{port:null!==(r=process.env.PORT)&&void 0!==r?r:3001,cors:{origin:"http://localhost:3000"}}};t.default=n},5955:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.rolesRepository=t.projectMemberService=t.projectsMembersQueryService=t.projectsMembersRepository=t.projectsQueryService=t.projectsRepository=t.authRepository=void 0;var o=r(6896),i=n(r(4784)),u=n(r(9985)),a=n(r(5610)),s=n(r(8611)),c=n(r(8540)),l=n(r(1195)),f=n(r(8874));o.container.register("authRepository",{useClass:i.default}),o.container.register("projectsRepository",{useClass:l.default}),o.container.register("projectsQueryService",{useClass:c.default}),o.container.register("projectsMembersRepository",{useClass:s.default}),o.container.register("projectsMembersQueryService",{useClass:a.default}),o.container.register("projectMemberService",{useClass:u.default}),o.container.register("rolesRepository",{useClass:f.default}),t.authRepository=o.container.resolve("authRepository"),t.projectsRepository=o.container.resolve("projectsRepository"),t.projectsQueryService=o.container.resolve("projectsQueryService"),t.projectsMembersRepository=o.container.resolve("projectsMembersRepository"),t.projectsMembersQueryService=o.container.resolve("projectsMembersQueryService"),t.projectMemberService=o.container.resolve("projectMemberService"),t.rolesRepository=o.container.resolve("rolesRepository")},6536:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(7807)),a=i(r(8012)),s=i(r(7382)),c=r(6818),l=r(5955);t.default=function(){return{signup:function(e,t,r){return n(void 0,void 0,void 0,(function(){return o(this,(function(i){return n(void 0,void 0,void 0,(function(){var r,n,i,c,f,d;return o(this,(function(o){switch(o.label){case 0:return r=e.body,n=r.email,i=r.password,c=r.nickname,f=a.default.create(c),d=s.default.create(n,i),[4,l.authRepository.loginByEmail(d.email)];case 1:if(o.sent())throw new u.default("既に登録されているメールアドレスです");return[4,l.authRepository.signupByEmail(f,d)];case 2:return o.sent(),t.status(200).end(),[2]}}))})).catch(r),[2]}))}))},login:function(e,t){if(!e.user)throw new u.default("認証に失敗しました",401);var r=(0,c.signToken)(e.user);t.status(200).send({id:e.user.id,token:r})}}}},3533:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r){this._id=e,this._identifier=t,this._credential=r}return Object.defineProperty(e.prototype,"id",{get:function(){if(!this._id.isGenerated)throw new Error("IDが生成されていません");return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"identifier",{get:function(){return this._identifier},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"credential",{get:function(){return this._credential},enumerable:!1,configurable:!0}),e.prototype.setId=function(t){return new e(t,this._identifier,this._credential)},e}();t.default=r},7382:function(e,t,r){var n,o=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(3533)),a=i(r(332)),s=i(r(4970)),c=r(2701),l=function(e){function t(t,r){return e.call(this,c.NoneId.instance,t,r)||this}return o(t,e),t.create=function(e,r){var n=a.default.create(e),o=s.default.create(r);return new t(n.value,o.encrepted)},Object.defineProperty(t.prototype,"email",{get:function(){return this.identifier},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"password",{get:function(){return this.credential},enumerable:!1,configurable:!0}),t}(u.default);t.default=l},332:function(e,t,r){var n,o=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(9596)),a=i(r(7807)),s=function(e){function t(t){return e.call(this,t)||this}return o(t,e),t.create=function(e){if(!/^[a-zA-Z0-9_.+-]+@([a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]*\.)+[a-zA-Z]{2,}$/.test(e))throw new a.default("メールアドレスの形式を確認してください",400);return new t(e)},t}(u.default);t.default=s},8012:function(e,t,r){var n,o=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(9596)),a=i(r(7807)),s=function(e){function t(t){return e.call(this,t)||this}return o(t,e),t.create=function(e){if(e.length<3||e.length>255)throw new a.default("ニックネームは3文字以上255文字以下で入力してください");return new t(e)},t}(u.default);t.default=s},4970:function(e,t,r){var n,o=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(9596)),a=i(r(7807)),s=r(4482),c=function(e){function t(t){return e.call(this,t)||this}return o(t,e),t.create=function(e){if(e.length<5||e.length>255)throw new a.default("パスワードは5文字以上255文字以下で入力してください",400);return new t(e)},Object.defineProperty(t.prototype,"encrepted",{get:function(){return(0,s.hashSync)(this._value)},enumerable:!1,configurable:!0}),t}(u.default);t.default=c},5402:function(e,t,r){var n,o,i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},u=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var s=a(r(3511)),c=a(r(7807)),l=r(7055),f=r(136),d=r(4253),p=r(6818),h=r(4482),_=r(5955);s.default.use(new l.Strategy({usernameField:"email",passwordField:"password",session:!1},(function(e,t,r){return i(void 0,void 0,void 0,(function(){var n,o;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,_.authRepository.loginByEmail(e)];case 1:return(n=i.sent())&&(0,h.compareSync)(t,n.credential)?[2,r(null,{id:n.id.value})]:[2,r(new c.default("メールアドレスまたはパスワードが誤っています",401))];case 2:return o=i.sent(),[2,r(o)];case 3:return[2]}}))}))})));var v={jwtFromRequest:f.ExtractJwt.fromAuthHeaderAsBearerToken(),secretOrKey:p.JWT_SECRET_KEY};s.default.use(new f.Strategy(v,(function(e,t){t(null,e)}))),s.default.use(new d.Strategy({clientID:null!==(n=process.env.GITHUB_CLIENT_ID)&&void 0!==n?n:"INVALID_CLIENT_ID",clientSecret:null!==(o=process.env.GITHUB_CLIENT_SECRET)&&void 0!==o?o:"INVALID_CLIENT_SECRET",callbackURL:"http://localhost:3001/api/v1/auth/github/callback"},(function(e,t,r,n){return i(void 0,void 0,void 0,(function(){var t,o;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,_.authRepository.authByGithub(r.username,r.id,e)];case 1:return t=i.sent(),[2,n(null,{id:t.id.value})];case 2:return o=i.sent(),[2,n(o)];case 3:return[2]}}))}))}))),t.default=s.default},4784:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(3533)),a=r(2701),s=r(8203),c=function(){function e(){}return e.prototype.signupByEmail=function(e,t){return n(this,void 0,void 0,(function(){var r=this;return o(this,(function(i){switch(i.label){case 0:return[4,s.prisma.$transaction((function(i){return n(r,void 0,void 0,(function(){var r;return o(this,(function(n){switch(n.label){case 0:return[4,i.users.create({data:{nickname:e.value}})];case 1:return r=n.sent(),[4,i.users_auths.create({data:{identity_type:"email",identifier:t.email,credential:t.password,users:{connect:{id:r.id}}}})];case 2:return n.sent(),[2]}}))}))}))];case 1:return i.sent(),[2]}}))}))},e.prototype.loginByEmail=function(e){return n(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:return[4,s.prisma.users_auths.findFirst({where:{identity_type:"email",identifier:e},include:{users:{select:{id:!0}}}})];case 1:return(t=r.sent())?[2,this.createAuthCredential(t.users.id,t.identifier,t.credential)]:[2,t]}}))}))},e.prototype.authByGithub=function(e,t,r){return n(this,void 0,void 0,(function(){var n,i,u;return o(this,(function(o){switch(o.label){case 0:return[4,s.prisma.users_auths.findFirst({where:{identity_type:"github",identifier:t},include:{users:{select:{id:!0}}}})];case 1:return(n=o.sent())?[4,s.prisma.users_auths.update({where:{id:n.id},data:{credential:r}})]:[3,3];case 2:return o.sent(),[2,this.createAuthCredential(n.users.id,n.identifier,r)];case 3:return[4,s.prisma.users.create({data:{nickname:e}})];case 4:return i=o.sent(),console.log(i),[4,s.prisma.users_auths.create({data:{identity_type:"github",identifier:t,credential:r,users:{connect:{id:i.id}}}})];case 5:return u=o.sent(),[2,this.createAuthCredential(i.id,u.identifier,u.credential)]}}))}))},e.prototype.createAuthCredential=function(e,t,r){var n=new a.GeneratedId(e);return new u.default(n,t,r)},e}();t.default=c},6729:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(7807)),a=i(r(4021)),s=r(5955),c=r(2701),l=r(2424);t.default=function(){return{add:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,f,d,p,h,_,v,b,y;return o(this,(function(o){switch(o.label){case 0:if(r=null===(y=e.user)||void 0===y?void 0:y.id,n=e.params.projectId,i=e.body,f=i.roleId,d=i.userId,!r)throw new u.default("認証に失敗しました",401);if(p=c.GeneratedId.validate(Number(n)||-1),h=c.GeneratedId.validate(Number(d)||-1),!(_=(0,l.getRole)(Number(f)||-1)))throw new u.default("追加するメンバーに付与する権限が不正です",400);return[4,s.rolesRepository.fetchRoleId(p,r)];case 1:if(v=o.sent(),!(0,l.checkPermission)(v,"member:add",{targetRoleId:_.id}))throw new u.default("メンバーを追加する権限がありません",403);return[4,s.projectMemberService.isExist(p,h)];case 2:if(o.sent())throw new u.default("すでにプロジェクトに参加しています",400);return[4,s.projectMemberService.isMaxMember(p)];case 3:if(o.sent())throw new u.default("メンバー数が上限に達しています",400);return b=new a.default(p,h,_),[4,s.projectsMembersRepository.add(b)];case 4:return o.sent(),t.status(200).send({userId:b.userId.value,role:{id:b.role.id,name:b.role.name}}),[2]}}))})).catch(r)},fetchList:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,a,f,d;return o(this,(function(o){switch(o.label){case 0:if(r=null===(d=e.user)||void 0===d?void 0:d.id,n=e.params.projectId,!r)throw new u.default("認証に失敗しました",401);return i=c.GeneratedId.validate(Number(n)||-1),[4,s.rolesRepository.fetchRoleId(i,r)];case 1:if(a=o.sent(),!(0,l.checkPermission)(a,"member:read"))throw new u.default("メンバー一覧を取得する権限がありません",403);return[4,s.projectsMembersQueryService.fetchList(i)];case 2:return f=o.sent(),t.status(200).send({members:f.members}),[2]}}))})).catch(r)},update:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,f,d,p,h,_,v,b,y,m,w;return o(this,(function(o){switch(o.label){case 0:if(r=null===(w=e.user)||void 0===w?void 0:w.id,n=e.params.projectId,i=e.params.userId,f=e.body.roleId,!r)throw new u.default("認証に失敗しました",401);if(d=c.GeneratedId.validate(Number(n)||-1),p=c.GeneratedId.validate(Number(i)||-1),!(h=(0,l.getRole)(Number(f)||-1)))throw new u.default("更新するメンバーに付与する権限が不正です",400);return[4,s.rolesRepository.fetchRoleList(d)];case 1:if(_=o.sent(),v=_.getRole(r),!(0,l.checkPermission)(v,"member:update",{targetRoleId:h.id}))throw new u.default("メンバーを更新する権限がありません",403);return[4,s.projectMemberService.isExist(d,p)];case 2:if(!o.sent())throw new u.default("プロジェクトに参加していません",400);if(b=_.getRole(p.value),!(y=(0,l.getRole)(b)))throw new u.default("更新するメンバーの権限が見つかりませんでした",404);if(y===l.ROLE_LIST.ADMINISTRATOR)throw new u.default("管理者を別の権限に変更することはできません",400);return m=new a.default(d,p,h),[4,s.projectsMembersRepository.update(m)];case 3:return o.sent(),t.status(200).send(),[2]}}))})).catch(r)},remove:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,a,f,d,p,h,_;return o(this,(function(o){switch(o.label){case 0:if(r=null===(_=e.user)||void 0===_?void 0:_.id,n=e.params.projectId,i=e.params.userId,!r)throw new u.default("認証に失敗しました",401);if(a=c.GeneratedId.validate(Number(i)||-1),new c.GeneratedId(r).equals(a))throw new u.default("自分を削除することはできません",400);return f=c.GeneratedId.validate(Number(n)||-1),[4,s.rolesRepository.fetchRoleList(f)];case 1:if(d=o.sent(),p=d.getRole(r),h=d.getRole(a.value),!(0,l.checkPermission)(p,"member:remove",{targetRoleId:h}))throw new u.default("メンバーを削除する権限がありません",403);return[4,s.projectsMembersRepository.remove(f,a)];case 2:return o.sent(),t.status(200).end(),[2]}}))})).catch(r)}}}},4021:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r){this._projectId=e,this._userId=t,this._role=r}return Object.defineProperty(e.prototype,"projectId",{get:function(){return this._projectId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userId",{get:function(){return this._userId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"role",{get:function(){return this._role},enumerable:!1,configurable:!0}),e.prototype.equals=function(e){return this.projectId.equals(e.projectId)&&this.userId.equals(e.userId)},e}();t.default=r},9985:function(e,t,r){var n=this&&this.__decorate||function(e,t,r,n){var o,i=arguments.length,u=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)u=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(u=(i<3?o(u):i>3?o(t,r,u):o(t,r))||u);return i>3&&u&&Object.defineProperty(t,r,u),u},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}},u=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var s=r(6896),c=function(){function e(e){this.MAX_MEMBER_LENGTH=30,this.queryService=e}return e.prototype.isExist=function(e,t){return u(this,void 0,void 0,(function(){return a(this,(function(r){return[2,this.queryService.find(e,t)]}))}))},e.prototype.isMaxMember=function(e){return u(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return[4,this.queryService.count(e)];case 1:return[2,t.sent()>=this.MAX_MEMBER_LENGTH]}}))}))},n([(0,s.injectable)(),i(0,(0,s.inject)("projectsMembersQueryService")),o("design:paramtypes",[Object])],e)}();t.default=c},3388:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MemberListDTO=void 0;var r=function(){function e(e){this._members=e,Object.freeze(this)}return Object.defineProperty(e.prototype,"members",{get:function(){return this._members},enumerable:!1,configurable:!0}),e}();t.MemberListDTO=r},5610:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=r(8203),a=r(3388),s=i(r(7807)),c=function(){function e(){}return e.prototype.fetchList=function(e){return n(this,void 0,void 0,(function(){var t,r;return o(this,(function(n){switch(n.label){case 0:return[4,u.prisma.projects.findFirst({where:{id:e.value,delete_flag:!1},include:{projects_members:{where:{delete_flag:!1},include:{users:!0,roles:!0}}}})];case 1:if(!(t=n.sent()))throw new s.default("プロジェクトが存在しません",404);return r=t.projects_members.map((function(e){return{userId:e.user_id,name:e.users.nickname,role:{id:e.roles.id,name:e.roles.name}}})),[2,new a.MemberListDTO(r)]}}))}))},e.prototype.find=function(e,t){return n(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:return[4,u.prisma.projects_members.findFirst({where:{project_id:e.value,user_id:t.value,delete_flag:!1}})];case 1:return r.sent()?[2,!0]:[2,!1]}}))}))},e.prototype.count=function(e){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,u.prisma.projects_members.count({where:{project_id:e.value,delete_flag:!1}})];case 1:return[2,t.sent()]}}))}))},e}();t.default=c},8611:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=r(8203),a=i(r(7807)),s=function(){function e(){}return e.prototype.add=function(e){return n(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,u.prisma.projects_members.upsert({where:{project_id_user_id:{project_id:e.projectId.value,user_id:e.userId.value}},update:{delete_flag:!1},create:{project_id:e.projectId.value,user_id:e.userId.value,role_id:e.role.id}})];case 1:return r.sent(),[3,3];case 2:if((t=r.sent())instanceof u.PrismaClientKnownRequestError&&"P2003"===t.code)throw new a.default("そのユーザーは存在しません",400);throw new a.default("プロジェクトメンバーの追加に失敗しました");case 3:return[2]}}))}))},e.prototype.update=function(e){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,u.prisma.projects_members.update({where:{project_id_user_id:{project_id:e.projectId.value,user_id:e.userId.value}},data:{role_id:e.role.id}})];case 1:return t.sent(),[2]}}))}))},e.prototype.remove=function(e,t){return n(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:return[4,u.prisma.projects_members.update({where:{project_id_user_id:{project_id:e.value,user_id:t.value}},data:{delete_flag:!0}})];case 1:return r.sent(),[2]}}))}))},e}();t.default=s},290:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(7807)),a=i(r(3964)),s=i(r(8462)),c=r(2701),l=r(5955),f=r(2424);t.default=function(){return{create:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,s,f,d,p;return o(this,(function(o){switch(o.label){case 0:if(r=null===(p=e.user)||void 0===p?void 0:p.id,n=e.body,i=n.name,s=n.description,!r)throw new u.default("認証に失敗しました",401);return f=a.default.create(new c.GeneratedId(r),i,s),[4,l.projectsRepository.create(f)];case 1:return d=o.sent(),t.status(200).send({id:d.detail.id.value,name:d.detail.name.value,description:d.detail.description.value}),[2]}}))})).catch(r)},fetchById:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,a,s,f;return o(this,(function(o){switch(o.label){case 0:if(r=e.params.id,!(n=null===(f=e.user)||void 0===f?void 0:f.id))throw new u.default("認証に失敗しました",401);return i=c.GeneratedId.validate(Number(r)||-1),[4,l.projectsQueryService.fetchById(i.value)];case 1:if(a=o.sent(),!(s=a.members.find((function(e){return e.userId===n}))))throw new u.default("プロジェクトに参加していません",403);return t.status(200).send({id:a.id,name:a.name,description:a.description,roleId:s.role.id,members:a.members}),[2]}}))})).catch(r)},fetchList:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i;return o(this,(function(o){switch(o.label){case 0:if(!(r=null===(i=e.user)||void 0===i?void 0:i.id))throw new u.default("認証に失敗しました",401);return[4,l.projectsQueryService.fetchList(r)];case 1:return n=o.sent(),t.status(200).send({projects:n.map((function(e){return{id:e.id,name:e.name,description:e.description}}))}),[2]}}))})).catch(r)},update:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,a,d,p,h,_,v,b;return o(this,(function(o){switch(o.label){case 0:if(r=e.params.id,n=null===(b=e.user)||void 0===b?void 0:b.id,i=e.body,a=i.name,d=i.description,!n)throw new u.default("認証に失敗しました",401);return p=c.GeneratedId.validate(Number(r)||-1),[4,l.rolesRepository.fetchRoleId(p,n)];case 1:if(h=o.sent(),!(0,f.checkPermission)(h,"project:update"))throw new u.default("プロジェクトを更新する権限がありません",403);return _=s.default.create(a,d),v=_.setId(p),[4,l.projectsRepository.update(v)];case 2:return o.sent(),t.status(200).send({id:v.id.value,name:v.name.value,description:v.description.value}),[2]}}))})).catch(r)},remove:function(e,t,r){n(void 0,void 0,void 0,(function(){var r,n,i,a,s;return o(this,(function(o){switch(o.label){case 0:if(r=e.params.id,!(n=null===(s=e.user)||void 0===s?void 0:s.id))throw new u.default("認証に失敗しました",401);return i=c.GeneratedId.validate(Number(r)||-1),[4,l.rolesRepository.fetchRoleId(i,n)];case 1:if(a=o.sent(),!(0,f.checkPermission)(a,"project:remove"))throw new u.default("プロジェクトを削除する権限がありません",403);return[4,l.projectsRepository.remove(i)];case 2:return o.sent(),t.status(200).end(),[2]}}))})).catch(r)}}}},7827:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var n=r(2701),o=r(2424),i=function(){function e(e,t,r){this._projectId=e,this._userId=t,this._role=r}return e.ADMINISTRATOR=function(t){return new e(n.NoneId.instance,t,o.ROLE_LIST.ADMINISTRATOR)},Object.defineProperty(e.prototype,"projectId",{get:function(){return this._projectId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userId",{get:function(){return this._userId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"role",{get:function(){return this._role},enumerable:!1,configurable:!0}),e.prototype.setId=function(t){return new e(t,this._userId,this._role)},e}();t.default=i},3964:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(r(7827)),i=n(r(8462)),u=function(){function e(e,t){this._detail=e,this._members=t}return e.create=function(t,r,n){return new e(i.default.create(r,n),[o.default.ADMINISTRATOR(t)])},Object.defineProperty(e.prototype,"detail",{get:function(){return this._detail},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"members",{get:function(){return this._members},enumerable:!1,configurable:!0}),e.prototype.setId=function(t){return new e(this._detail.setId(t),this._members.map((function(e){return e.setId(t)})))},e.prototype.isMemberExist=function(e){return this._members.some((function(t){return t.userId.equals(e)}))},e.prototype.isMemberFull=function(){return this._members.length>=e.MAX_MEMBERS},e.MAX_MEMBERS=30,e}();t.default=u},8462:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(r(1179)),i=n(r(1090)),u=r(2701),a=function(){function e(e,t,r){this._id=e,this._name=t,this._description=r}return e.create=function(t,r){return new e(u.NoneId.instance,i.default.create(t),o.default.create(r))},Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!1,configurable:!0}),e.prototype.setId=function(t){return new e(t,this._name,this._description)},e}();t.default=a},1179:function(e,t,r){var n,o=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(9596)),a=i(r(7807)),s=function(e){function t(t){return e.call(this,t)||this}return o(t,e),t.create=function(e){if(!e)return new t("");if(e.length>255)throw new a.default("プロジェクトの説明は255文字以下で入力してください",400);return new t(e)},t}(u.default);t.default=s},1090:function(e,t,r){var n,o=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(9596)),a=i(r(7807)),s=function(e){function t(t){return e.call(this,t)||this}return o(t,e),t.create=function(e){if(!e)throw new a.default("プロジェクト名を入力してください",400);if(e.length<3||e.length>255)throw new a.default("プロジェクト名は3文字以上255文字以下で入力してください",400);return new t(e)},t}(u.default);t.default=s},2343:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectListItemDTO=t.ProjectDTO=void 0;var r=function(){function e(e,t,r,n){this._id=e,this._name=t,this._description=r,this._members=n,Object.freeze(this)}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"members",{get:function(){return this._members},enumerable:!1,configurable:!0}),e}();t.ProjectDTO=r;var n=function(){function e(e,t,r){this._id=e,this._name=t,this._description=r,Object.freeze(this)}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!1,configurable:!0}),e}();t.ProjectListItemDTO=n},8540:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(7807)),a=r(8203),s=r(2343),c=function(){function e(){}return e.prototype.fetchList=function(e){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,a.prisma.projects.findMany({where:{delete_flag:!1,projects_members:{some:{user_id:e,delete_flag:!1}}},orderBy:{updated_at:"desc"}})];case 1:return[2,t.sent().map((function(e){return new s.ProjectListItemDTO(e.id,e.name,e.description)}))]}}))}))},e.prototype.fetchById=function(e){return n(this,void 0,void 0,(function(){var t,r;return o(this,(function(n){switch(n.label){case 0:return[4,a.prisma.projects.findFirst({where:{id:e,delete_flag:!1},include:{projects_members:{where:{delete_flag:!1},include:{users:!0,roles:!0}}}})];case 1:if(!(t=n.sent()))throw new u.default("プロジェクトが存在しません",404);return r=t.projects_members.map((function(e){return{userId:e.user_id,name:e.users.nickname,role:{id:e.roles.id,name:e.roles.name}}})),[2,new s.ProjectDTO(t.id,t.name,t.description,r)]}}))}))},e}();t.default=c},1195:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(7807)),a=r(2701),s=r(8203),c=r(5747),l=function(){function e(){}return e.prototype.create=function(e){return n(this,void 0,void 0,(function(){var t,r,i,l=this;return o(this,(function(f){switch(f.label){case 0:if(!(t=e.members[0]))throw new u.default("プロジェクトのオーナーが存在しません",400);return[4,s.prisma.$transaction((function(r){return n(l,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,r.projects.create({data:{name:e.detail.name.value,description:e.detail.description.value,updated_at:(0,c.now)(),projects_members:{create:{user_id:t.userId.value,role_id:t.role.id}}}})];case 1:return[2,n.sent()]}}))}))}))];case 1:return r=f.sent(),i=new a.GeneratedId(r.id),[2,e.setId(i)]}}))}))},e.prototype.update=function(e){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,s.prisma.projects.update({where:{id:e.id.value},data:{name:e.name.value,description:e.description.value,updated_at:(0,c.now)()}})];case 1:return t.sent(),[2]}}))}))},e.prototype.remove=function(e){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,s.prisma.projects.update({where:{id:e.value},data:{delete_flag:!0}})];case 1:return t.sent(),[2]}}))}))},e}();t.default=l},8500:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectMemberRoleList=void 0;var o=n(r(7807)),i=function(){function e(e){this._roles=e,Object.freeze(this)}return Object.defineProperty(e.prototype,"roles",{get:function(){return this._roles},enumerable:!1,configurable:!0}),e.prototype.getRole=function(e){var t=this._roles.find((function(t){return t.userId===e}));if(!t)throw new o.default("プロジェクトに参加していません",403);return t.roleId},e}();t.ProjectMemberRoleList=i},8874:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=i(r(7807)),a=r(8203),s=r(8500),c=function(){function e(){}return e.prototype.fetchRoleId=function(e,t){return n(this,void 0,void 0,(function(){var r;return o(this,(function(n){switch(n.label){case 0:return[4,a.prisma.projects.findFirst({where:{id:e.value,delete_flag:!1}})];case 1:if(!n.sent())throw new u.default("プロジェクトが存在しません",404);return[4,a.prisma.projects_members.findFirst({where:{project_id:e.value,user_id:t,delete_flag:!1}})];case 2:if(!(r=n.sent()))throw new u.default("プロジェクトに参加していません",403);return[2,r.role_id]}}))}))},e.prototype.fetchRoleList=function(e){return n(this,void 0,void 0,(function(){var t,r;return o(this,(function(n){switch(n.label){case 0:return[4,a.prisma.projects.findFirst({where:{id:e.value,delete_flag:!1}})];case 1:if(!n.sent())throw new u.default("プロジェクトが存在しません",404);return[4,a.prisma.projects_members.findMany({where:{project_id:e.value,delete_flag:!1}})];case 2:return t=n.sent(),r=t.map((function(e){return{userId:e.user_id,roleId:e.role_id}})),[2,new s.ProjectMemberRoleList(r)]}}))}))},e}();t.default=c},2701:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NoneId=t.GeneratedId=void 0;var o=n(r(7807)),i=function(){function e(e){this.isGenerated=!0,this._value=e,Object.freeze(this)}return e.validate=function(t){if(t<1||!Number.isInteger(t))throw new o.default("IDは1以上の整数で入力してください",400);return new e(t)},Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!1,configurable:!0}),e.prototype.equals=function(e){return this.value===e.value},e}();t.GeneratedId=i;var u=function(){function e(){this.isGenerated=!1}return Object.defineProperty(e.prototype,"value",{get:function(){throw new o.default("IDが生成されていません",400)},enumerable:!1,configurable:!0}),e.instance=new e,e}();t.NoneId=u},9596:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this._value=e,Object.freeze(this)}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!1,configurable:!0}),e.prototype.equals=function(e){return this.constructor.name===e.constructor.name&&this._value===e.value},e}();t.default=r},8203:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.prisma=t.PrismaClientKnownRequestError=void 0;var n=r(3524),o=r(5423);Object.defineProperty(t,"PrismaClientKnownRequestError",{enumerable:!0,get:function(){return o.PrismaClientKnownRequestError}}),t.prisma=new n.PrismaClient},9039:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(3236);var o=n(r(7280)),i=r(1055),u=o.default.server.port;i.listen(u,(function(){console.log("Server listening on port ".concat(u))}))},5635:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(r(4527)),i=n(r(565));t.default=function(e){e.use((function(e,t,r,n){var u=e.status||500,a=new o.default;i.default.error(e.message),r.status(u).send(a.error(e))}))}},2919:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.authRouter=void 0;var o=n(r(5402)),i=n(r(6536));t.authRouter=function(e){var t=e.Router(),r=(0,i.default)();return t.post("/auth/signup",r.signup),t.post("/auth/login",o.default.authenticate("local",{session:!1,scope:["user:email"]}),r.login),t.get("/auth/github",o.default.authenticate("github",{session:!1})),t.get("/auth/github/callback",o.default.authenticate("github",{session:!1}),r.login),t}},9736:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),o=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),o(r(2919),t),o(r(9413),t),o(r(1407),t)},9413:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.projectRouter=void 0;var o=n(r(5402)),i=n(r(290));t.projectRouter=function(e){var t=e.Router(),r=(0,i.default)();return t.route("/").get(o.default.authenticate("jwt",{session:!1}),r.fetchList).post(o.default.authenticate("jwt",{session:!1}),r.create),t.route("/:id").get(o.default.authenticate("jwt",{session:!1}),r.fetchById).put(o.default.authenticate("jwt",{session:!1}),r.update).delete(o.default.authenticate("jwt",{session:!1}),r.remove),t}},1407:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.projectMemberRouter=void 0;var o=n(r(5402)),i=n(r(6729));t.projectMemberRouter=function(e){var t=e.Router({mergeParams:!0}),r=(0,i.default)();return t.route("/members").post(o.default.authenticate("jwt",{session:!1}),r.add).get(o.default.authenticate("jwt",{session:!1}),r.fetchList),t.route("/members/:userId").put(o.default.authenticate("jwt",{session:!1}),r.update).delete(o.default.authenticate("jwt",{session:!1}),r.remove),t},t.default=t.projectMemberRouter},1055:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(r(3582)),i=n(r(3685)),u=n(r(6860)),a=n(r(7280)),s=n(r(5635)),c=n(r(5402)),l=r(9736),f=(0,u.default)(),d=i.default.createServer(f);f.use(u.default.json()),f.use(u.default.urlencoded({extended:!1}));var p={origin:a.default.server.cors.origin,optionsSuccessStatus:200};f.use((0,o.default)(p)),f.use(c.default.initialize()),f.use("/api/v1",(0,l.authRouter)(u.default)),f.use("/api/v1/projects",(0,l.projectRouter)(u.default)),f.use("/api/v1/projects/:projectId",(0,l.projectMemberRouter)(u.default)),(0,s.default)(f),e.exports=d},5747:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.now=void 0,t.now=function(){return new Date((new Date).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo"}))}},7807:function(e,t){var r,n=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(t,r){void 0===r&&(r=500);var n=e.call(this,t)||this;return n.message=t,n.status=r,n}return n(t,e),t}(Error);t.default=o},4482:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.compareSync=t.hashSync=void 0;var o=n(r(7096));t.hashSync=function(e){return o.default.hashSync(e,10)},t.compareSync=function(e,t){return o.default.compareSync(e,t)}},6818:function(e,t,r){var n,o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.signToken=t.JWT_SECRET_KEY=void 0;var i=o(r(9344));t.JWT_SECRET_KEY=null!==(n=process.env.JWT_SECRET_KEY)&&void 0!==n?n:"MY_SECRET_KEY",t.signToken=function(e,r){return i.default.sign(e,t.JWT_SECRET_KEY,r)}},565:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var n=r(7042);t.default=n.logger},7042:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;var o=n(r(7773));t.logger=o.default.createLogger({level:"info",format:o.default.format.json(),defaultMeta:{service:"user-service"},transports:[new o.default.transports.File({filename:"logs/error.log",level:"error"}),new o.default.transports.File({filename:"logs/combined.log"})]})},4527:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.error=function(e){return{message:e.message}},e}();t.default=r},2424:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.checkPermission=t.getRole=t.rules=t.ROLE_LIST=void 0,t.ROLE_LIST={ADMINISTRATOR:{id:1,name:"管理者"},LEADER:{id:4,name:"リーダー"},DEVELOPER:{id:3,name:"開発者"},CLIENT:{id:2,name:"クライアント"}},t.rules={ADMINISTRATOR:{static:["project:update","project:remove","member:read"],dynamic:{"member:add":function(e){var r=e.targetRoleId;return!!r&&r!==t.ROLE_LIST.ADMINISTRATOR.id},"member:update":function(e){var r=e.targetRoleId;return!!r&&r!==t.ROLE_LIST.ADMINISTRATOR.id},"member:remove":function(e){var r=e.targetRoleId;return!!r&&r!==t.ROLE_LIST.ADMINISTRATOR.id}}},LEADER:{static:["project:update","member:read"],dynamic:{"member:add":function(e){return e.targetRoleId!==t.ROLE_LIST.ADMINISTRATOR.id&&e.targetRoleId!==t.ROLE_LIST.LEADER.id},"member:update":function(e){return e.targetRoleId!==t.ROLE_LIST.ADMINISTRATOR.id&&e.targetRoleId!==t.ROLE_LIST.LEADER.id},"member:remove":function(e){var r=e.targetRoleId;return!!r&&r!==t.ROLE_LIST.ADMINISTRATOR.id}}},DEVELOPER:{static:["member:read"],dynamic:{}},CLIENT:{static:["member:read"],dynamic:{}}},t.getRole=function(e){return Object.values(t.ROLE_LIST).find((function(t){return t.id===e}))},t.checkPermission=function(e,r,n){var o=Object.keys(t.ROLE_LIST).find((function(r){return t.ROLE_LIST[r].id===e}));if(void 0===o)return!1;if(t.rules[o].static.includes(r))return!0;var i=t.rules[o].dynamic[r];return!(!i||!n)&&i(n)}},3524:e=>{e.exports=require("@prisma/client")},5423:e=>{e.exports=require("@prisma/client/runtime")},7096:e=>{e.exports=require("bcrypt")},3582:e=>{e.exports=require("cors")},6860:e=>{e.exports=require("express")},9344:e=>{e.exports=require("jsonwebtoken")},3511:e=>{e.exports=require("passport")},4253:e=>{e.exports=require("passport-github2")},136:e=>{e.exports=require("passport-jwt")},7055:e=>{e.exports=require("passport-local")},3236:e=>{e.exports=require("reflect-metadata")},6896:e=>{e.exports=require("tsyringe")},7773:e=>{e.exports=require("winston")},3685:e=>{e.exports=require("http")}},t={};!function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}(9039)})();